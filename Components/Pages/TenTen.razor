@page "/tenten"
@using System.Linq
@using MeTenTenMaui.Models
@using MeTenTenMaui.Services
@inject ITenTenService TenTenService
@inject ITopicService TopicService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>10&10 - MeTenTen</PageTitle>

<BreadcrumbNavigator CurrentPageTitle="10&10" />

<div class="tenten-container">
    <div class="tenten-header">
        <h1>💕 10&10</h1>
        <p>10분간 마음을 적고 10분간 대화를 나누세요</p>
    </div>

    <!-- 월별 필터링 -->
    <div class="month-filter">
        <div class="filter-section">
            <label for="monthSelect">월 선택:</label>
            <select id="monthSelect" @bind="selectedMonth" class="form-control">
                @for (int i = 0; i < 12; i++)
                {
                    var month = DateTime.Now.AddMonths(-i);
                    <option value="@month.ToString("yyyy-MM")">@month.ToString("yyyy년 MM월")</option>
                }
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" @onclick="ShowNewTopicModal">
                <span class="bi bi-plus-circle"></span> 새 주제 추가
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (filteredTopics.Any())
    {
        <div class="topics-list">
            <h3>@selectedMonth.ToString("yyyy년 MM월") 주제 목록</h3>
            <div class="topics-grid">
                @foreach (var topic in filteredTopics.OrderByDescending(t => t.CreatedAt))
                {
                    <div class="topic-card" @onclick="() => SelectTopic(topic)">
                        <div class="topic-header">
                            <div class="topic-date">@topic.CreatedAt.ToString("MM-dd")</div>
                            <div class="topic-status">
                                @if (HasTenTenForTopic(topic.Id))
                                {
                                    <span class="status-badge completed">완료</span>
                                }
                                else
                                {
                                    <span class="status-badge pending">미작성</span>
                                }
                            </div>
                        </div>
                        <div class="topic-content">
                            <h4>@topic.Subject</h4>
                            <p>@topic.Description</p>
                        </div>
                        <div class="topic-actions">
                            <button class="btn btn-sm btn-outline-primary" @onclick:stopPropagation="true" @onclick="() => SelectTopic(topic)">
                                @if (HasTenTenForTopic(topic.Id))
                                {
                                    <span class="bi bi-eye"></span> @("보기")
                                }
                                else
                                {
                                    <span class="bi bi-pencil"></span> @("작성")
                                }
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">📝</div>
            <h3>@selectedMonth.ToString("yyyy년 MM월")에 작성된 주제가 없습니다</h3>
            <p>새 주제를 추가하거나 다른 월을 선택해보세요.</p>
        </div>
    }
</div>

<!-- 새 주제 추가 모달 -->
@if (showNewTopicModal)
{
    <div class="modal-overlay" @onclick="CloseNewTopicModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>새 주제 추가</h3>
                <button class="btn-close" @onclick="CloseNewTopicModal">&times;</button>
            </div>
            <div class="modal-body">
                <EditForm Model="newTopic" OnValidSubmit="SaveNewTopic">
                    <DataAnnotationsValidator />
                    
                    <div class="form-group">
                        <label for="topicDate">날짜 *</label>
                        <InputDate id="topicDate" @bind-Value="newTopic.TopicDate" class="form-control" />
                        <ValidationMessage For="@(() => newTopic.TopicDate)" class="text-danger" />
                    </div>

                    <div class="form-group">
                        <label for="topicSubject">주제 *</label>
                        <InputText id="topicSubject" @bind-Value="newTopic.Subject" 
                                 class="form-control" placeholder="주제를 입력하세요" />
                        <ValidationMessage For="@(() => newTopic.Subject)" class="text-danger" />
                    </div>

                    <div class="form-group">
                        <label for="topicDescription">설명</label>
                        <InputTextArea id="topicDescription" @bind-Value="newTopic.Description" 
                                     class="form-control" rows="3" placeholder="주제에 대한 설명을 입력하세요" />
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseNewTopicModal">취소</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- 10&10 작성/보기 모달 -->
@if (showTenTenModal)
{
    <div class="modal-overlay" @onclick="CloseTenTenModal">
        <div class="modal-content ten-ten-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(isEditing ? "10&10 수정" : "10&10 작성")</h3>
                <button class="btn-close" @onclick="CloseTenTenModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (selectedTopic != null)
                {
                    <div class="topic-info">
                        <h4>@selectedTopic.Subject</h4>
                        <p>@selectedTopic.Description</p>
                        <small class="text-muted">작성일: @selectedTopic.CreatedAt.ToString("yyyy-MM-dd")</small>
                    </div>

                    <EditForm Model="currentTenTen" OnValidSubmit="SaveTenTen">
                        <DataAnnotationsValidator />
                        
                        <div class="form-group">
                            <label for="content">10&10 내용 *</label>
                            <div class="timer-container">
                                <div class="timer-display">
                                    <span class="timer-label">작성 시간:</span>
                                    <span class="timer-value @(isTimerRunning ? "running" : "")">@FormatTime(remainingTime)</span>
                                    @if (isTimerRunning)
                                    {
                                        <span class="timer-status">⏱️ 작성 중...</span>
                                    }
                                    else if (remainingTime == 0)
                                    {
                                        <span class="timer-status">✅ 시간 완료!</span>
                                    }
                                    else
                                    {
                                        <span class="timer-status">⏸️ 대기 중</span>
                                    }
                                </div>
                                <div class="timer-controls">
                                    @if (!isTimerRunning && remainingTime > 0)
                                    {
                                        <button type="button" class="btn btn-success btn-sm" @onclick="StartTimer">
                                            <span class="bi bi-play"></span> 시작
                                        </button>
                                    }
                                    else if (isTimerRunning)
                                    {
                                        <button type="button" class="btn btn-warning btn-sm" @onclick="PauseTimer">
                                            <span class="bi bi-pause"></span> 일시정지
                                        </button>
                                    }
                                    <button type="button" class="btn btn-secondary btn-sm" @onclick="ResetTimer">
                                        <span class="bi bi-arrow-clockwise"></span> 리셋
                                    </button>
                                </div>
                            </div>
                            <InputTextArea id="content" @bind-Value="currentTenTen.Content"
                                        class="@GetTextAreaClass()" rows="20"
                                        placeholder="10분간 마음을 적어보세요..." />
                            <ValidationMessage For="@(() => currentTenTen.Content)" class="text-danger" />
                            <small class="form-text text-muted">최소 10자 이상 입력해주세요.</small>
                        </div>

                        <div class="form-group">
                            <label for="emotionTag">감정 태그</label>
                            <InputText id="emotionTag" @bind-Value="currentTenTen.EmotionTag" 
                                     class="form-control" placeholder="예: 행복, 감사, 걱정 등" />
                        </div>

                        <div class="form-group">
                            <label for="importanceLevel">중요도 (1-5)</label>
                            <InputNumber id="importanceLevel" @bind-Value="currentTenTen.ImportanceLevel" 
                                       class="form-control" min="1" max="5" />
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseTenTenModal">취소</button>
                            <button type="submit" class="btn btn-primary">저장</button>
                        </div>
                    </EditForm>
                }
            </div>
        </div>
    </div>
}

@code {
    private List<MeTenTenMaui.Models.TenTen> tenTens = new();
    private List<MeTenTenMaui.Models.Topic> topics = new();
    private List<MeTenTenMaui.Models.Topic> filteredTopics = new();
    private DateTime selectedMonth = DateTime.Now;
    private bool isLoading = true;
    private bool showNewTopicModal = false;
    private bool showTenTenModal = false;
    private bool isEditing = false;
    private MeTenTenMaui.Models.Topic? selectedTopic;
    private MeTenTenMaui.Models.CreateTenTenRequest currentTenTen = new();
    private MeTenTenMaui.Models.CreateTopicRequest newTopic = new();

    // 타이머 관련 변수
    private int remainingTime = 600; // 10분 = 600초
    private bool isTimerRunning = false;
    private Timer? timer;
    private DateTime timerStartTime;
    private int pausedTime = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        FilterTopicsByMonth();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            tenTens = await TenTenService.GetAllTenTensAsync();
            topics = await TopicService.GetAllTopicsAsync();
        }
        catch (Exception ex)
        {
            // 에러 처리
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnMonthChanged()
    {
        FilterTopicsByMonth();
    }

    private void FilterTopicsByMonth()
    {
        var startDate = new DateTime(selectedMonth.Year, selectedMonth.Month, 1);
        var endDate = startDate.AddMonths(1).AddDays(-1);
        
        filteredTopics = topics.Where(t => t.CreatedAt >= startDate && t.CreatedAt <= endDate).ToList();
    }

    private bool HasTenTenForTopic(int topicId)
    {
        return tenTens.Any(t => t.TopicId == topicId);
    }

    private void ShowNewTopicModal()
    {
        newTopic = new MeTenTenMaui.Models.CreateTopicRequest
        {
            TopicDate = DateTime.Now,
            CreatedAt = DateTime.Now
        };
        showNewTopicModal = true;
    }

    private void CloseNewTopicModal()
    {
        showNewTopicModal = false;
        newTopic = new();
    }

    private async Task SaveNewTopic()
    {
        try
        {
            await TopicService.CreateTopicAsync(newTopic);
            await LoadData();
            FilterTopicsByMonth();
            CloseNewTopicModal();
        }
        catch (Exception ex)
        {
            // 에러 처리
        }
    }

    private void SelectTopic(MeTenTenMaui.Models.Topic topic)
    {
        selectedTopic = topic;
        var existingTenTen = tenTens.FirstOrDefault(t => t.TopicId == topic.Id);
        
        if (existingTenTen != null)
        {
            // 기존 10&10이 있으면 수정 모드
            isEditing = true;
            currentTenTen = new MeTenTenMaui.Models.CreateTenTenRequest
            {
                Content = existingTenTen.Content,
                TopicId = existingTenTen.TopicId,
                EmotionTag = existingTenTen.EmotionTag,
                ImportanceLevel = existingTenTen.ImportanceLevel
            };
        }
        else
        {
            // 기존 10&10이 없으면 새로 작성
            isEditing = false;
            currentTenTen = new MeTenTenMaui.Models.CreateTenTenRequest
            {
                TopicId = topic.Id
            };
        }
        
        showTenTenModal = true;
    }

    private void CloseTenTenModal()
    {
        showTenTenModal = false;
        selectedTopic = null;
        currentTenTen = new();
        StopTimer();
    }

    private async Task SaveTenTen()
    {
        try
        {
            if (isEditing)
            {
                var existingTenTen = tenTens.FirstOrDefault(t => t.TopicId == currentTenTen.TopicId);
                if (existingTenTen != null)
                {
                    existingTenTen.Content = currentTenTen.Content;
                    existingTenTen.EmotionTag = currentTenTen.EmotionTag;
                    existingTenTen.ImportanceLevel = currentTenTen.ImportanceLevel;
                    await TenTenService.UpdateTenTenAsync(existingTenTen);
                }
            }
            else
            {
                await TenTenService.CreateTenTenAsync(currentTenTen);
            }
            
            await LoadData();
            CloseTenTenModal();
        }
        catch (Exception ex)
        {
            // 에러 처리
        }
    }

    // 타이머 관련 메서드들
    private void StartTimer()
    {
        if (!isTimerRunning && remainingTime > 0)
        {
            isTimerRunning = true;
            timerStartTime = DateTime.Now;
            timer = new Timer(TimerCallback, null, 0, 1000); // 1초마다 업데이트
            StateHasChanged();
        }
    }

    private void PauseTimer()
    {
        if (isTimerRunning)
        {
            isTimerRunning = false;
            timer?.Dispose();
            pausedTime = remainingTime;
            StateHasChanged();
        }
    }

    private void ResetTimer()
    {
        StopTimer();
        remainingTime = 600; // 10분으로 리셋
        pausedTime = 0;
        StateHasChanged();
    }

    private void StopTimer()
    {
        isTimerRunning = false;
        timer?.Dispose();
        timer = null;
    }

    private void TimerCallback(object? state)
    {
        if (isTimerRunning)
        {
            var elapsed = (int)(DateTime.Now - timerStartTime).TotalSeconds;
            remainingTime = Math.Max(0, 600 - elapsed);

            if (remainingTime <= 0)
            {
                isTimerRunning = false;
                timer?.Dispose();
                InvokeAsync(() => {
                    StateHasChanged();
                });
            }
            else
            {
                InvokeAsync(StateHasChanged);
            }
        }
    }

    private string FormatTime(int seconds)
    {
        var minutes = seconds / 60;
        var remainingSeconds = seconds % 60;
        return $"{minutes:D2}:{remainingSeconds:D2}";
    }

    private string GetTextAreaClass()
    {
        var baseClass = "form-control content-textarea";
        if (isTimerRunning)
        {
            baseClass += " writing-mode";
        }
        return baseClass;
    }

    public void Dispose()
    {
        StopTimer();
    }
}
}
